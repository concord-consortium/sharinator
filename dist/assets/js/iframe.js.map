{"version":3,"sources":["webpack:///./src/iframe.tsx","webpack:///./src/components/iframe.tsx"],"names":[],"mappings":";;;;;;;AAAA,mCAA+B;AAC/B,uCAAsC;AACtC,uCAA4C;AAE5C,QAAQ,CAAC,MAAM,CACX,oBAAC,eAAM,OAAG,EACV,QAAQ,CAAC,cAAc,CAAC,KAAK,CAAC,CACjC,CAAC;;;;;;;;;;;;;;;ACPF,mCAA+B;AAC/B,+CAAgD;AAEhD,IAAM,WAAW,GAAG,mBAAO,CAAC,EAAc,CAAC;AAC3C,IAAM,UAAU,GAAG,mBAAO,CAAC,EAAY,CAAC;AAyDxC;IAA4B,0BAAyC;IAWnE,gBAAY,KAAkB;QAA9B,YACE,kBAAM,KAAK,CAAC,SAeb;QAbC,KAAI,CAAC,mBAAmB,GAAG,KAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,KAAI,CAAC;QAC9D,KAAI,CAAC,mBAAmB,GAAG,KAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,KAAI,CAAC;QAC9D,KAAI,CAAC,YAAY,GAAG,KAAI,CAAC,YAAY,CAAC,IAAI,CAAC,KAAI,CAAC;QAEhD,KAAI,CAAC,KAAK,GAAG;YACX,MAAM,EAAE,IAAI;YACZ,GAAG,EAAE,IAAI;YACT,SAAS,EAAE,KAAK;YAChB,aAAa,EAAE,IAAI;YACnB,cAAc,EAAE,IAAI;YACpB,mBAAmB,EAAE,IAAI;YACzB,OAAO,EAAE,IAAI;SACd;;IACH,CAAC;IAED,kCAAiB,GAAjB;QACE,oDAAoD;QACpD,UAAU,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC;IACrC,CAAC;IAED,6BAAY,GAAZ;QAAA,iBAgCC;QA/BC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC,iBAAiB,EAAE;QAClD,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,iBAAiB,EAAE,UAAC,IAAwB;YACvE,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,KAAK,WAAW,CAAC,CAAC,CAAC;gBAC9B,KAAI,CAAC,QAAQ,CAAC;oBACZ,SAAS,EAAE,IAAI;oBACf,aAAa,EAAE,IAAI,CAAC,aAAa;iBAClC,CAAC;gBACF,MAAM;YACR,CAAC;YAED,IAAM,aAAa,GAAiB,IAAI,CAAC,aAAa;YACtD,IAAM,GAAG,GAAM,aAAa,CAAC,aAAa,SAAI,WAAW,CAAC,SAAS,CAAC,EAAC,MAAM,EAAE,aAAa,CAAC,QAAQ,EAAC,CAAG;YAEvG,KAAI,CAAC,QAAQ,CAAC;gBACZ,GAAG,EAAE,GAAG;gBACR,MAAM,EAAE,IAAI,CAAC,mBAAmB;gBAChC,mBAAmB,EAAE,IAAI;gBACzB,aAAa,EAAE,IAAI,CAAC,aAAa;aAClC,CAAC;YAEF,EAAE,CAAC,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAE,CAAC;gBAC9B,UAAU,CAAC,KAAI,CAAC,mBAAmB,EAAE,IAAI,CAAC;YAC5C,CAAC;QACH,CAAC,CAAC;QACF,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,CAAC;QAC9B,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,mBAAmB,EAAE;YACzC,UAAU,EAAE,CAAC;YACb,QAAQ,EAAE;gBACR,aAAa,EAAE,IAAI;aACpB;SACF,CAAC;IACJ,CAAC;IAED,mCAAkB,GAAlB;QAAA,iBAUC;QATC,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC;YACzB,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE;QACjC,CAAC;QACD,IAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;YAC/C,4EAA4E;YAC5E,IAAI,CAAC,WAAW,GAAG,IAAI,WAAW,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;gBAClE,KAAI,CAAC,WAAW,CAAC,IAAI,CAAC,iBAAiB,EAAE,KAAI,CAAC,KAAK,CAAC,mBAAmB,CAAC;YAC1E,CAAC,CAAC;QACJ,CAAC;IACH,CAAC;IAED,oCAAmB,GAAnB;QAAA,iBAwBC;QAvBC,IAAM,MAAM,GAAG,IAAI;QACnB,UAAU;aACP,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;aACtB,eAAe,EAAE;aACjB,GAAG,CAAC,QAAQ,EAAE,kBAAkB,CAAC;aACjC,GAAG,CAAC,UAAC,GAAO,EAAE,GAAO;YACpB,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;gBACT,IAAI,CAAC;oBACH,IAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC;oBACjC,EAAE,CAAC,CAAC,IAAI,IAAI,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;wBAC1B,IAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC;wBACzC,EAAE,CAAC,CAAC,OAAO,IAAI,OAAO,CAAC,QAAQ,IAAI,OAAO,CAAC,QAAQ,CAAC,UAAU,IAAI,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,QAAQ,IAAI,KAAI,CAAC,KAAK,CAAC,aAAa,CAAC,CAAC,CAAC;4BACnI,MAAM,CAAC,QAAQ,CAAC;gCACd,OAAO,EAAK,KAAI,CAAC,KAAK,CAAC,aAAa,CAAC,WAAW,6BAAwB,OAAO,CAAC,QAAQ,CAAC,QAAQ,uBAAkB,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,QAAU;6BAC1J,CAAC;wBACJ,CAAC;wBACD,MAAM;oBACR,CAAC;gBACH,CAAC;gBACD,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAC;gBACZ,UAAU,CAAC,KAAI,CAAC,mBAAmB,EAAE,IAAI,CAAC;YAC5C,CAAC;QACH,CAAC,CAAC,CAAC;IACP,CAAC;IAED,oCAAmB,GAAnB,UAAoB,CAAkC;QACpD,CAAC,CAAC,cAAc,EAAE;QAElB,IAAM,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK;QACrC,uBAA8C,EAA7C,mBAAW,EAAE,aAAK,EAAE,kBAAO,CAAkB;QAClD,IAAM,UAAU,GAAG,WAAW,CAAC,KAAK,CAAC,0DAA0D,CAAC;QAChG,IAAM,YAAY,GAAG,WAAW,CAAC,KAAK,CAAC,KAAK,IAAI,EAAE,CAAC;QAEnD,EAAE,CAAC,CAAC,CAAC,UAAU,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC,CAAC;YACxC,IAAI,CAAC,QAAQ,CAAC,EAAC,cAAc,EAAE,wEAAwE,EAAC,CAAC;YACzG,MAAM;QACR,CAAC;QACD,IAAI,CAAC,QAAQ,CAAC,EAAC,cAAc,EAAE,IAAI,EAAC,CAAC;QAErC,WAAW,GAAG,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC,EAAC,0BAA0B;QAE9F,IAAI,QAAQ;QACZ,mCAA2D,EAA1D,gBAAQ,EAAE,aAAK,EAAE,kBAAO,CAAkC;QAC3D,IAAM,WAAW,GAAG,WAAW,CAAC,KAAK,CAAC,KAAK,IAAI,EAAE,CAAC;QAClD,WAAW,CAAC,aAAa,GAAG,KAAK;QACjC,WAAW,CAAC,cAAc,GAAG,WAAW;QACxC,QAAQ,GAAG,IAAI,CAAC,aAAa,CAAI,QAAQ,SAAI,WAAW,CAAC,SAAS,CAAC,WAAW,CAAG,CAAC;QAElF,IAAM,aAAa,GAAiB;YAClC,aAAa,EAAE,GAAG;YAClB,WAAW,EAAE,WAAW,CAAC,cAAc;YACvC,aAAa,EAAE,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,SAAS,EAAE,aAAa,CAAC,CAAC;YAClF,QAAQ,EAAE,QAAQ;SACnB;QAED,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,eAAe,EAAE,aAAa,CAAC;;IACvD,CAAC;IAED,8BAAa,GAAb,UAAc,GAAU;QACtB,IAAM,CAAC,GAAG,QAAQ,CAAC,aAAa,CAAC,GAAG,CAAC;QACrC,CAAC,CAAC,IAAI,GAAG,GAAG;QACZ,CAAC,CAAC,QAAQ,GAAG,QAAQ,CAAC,QAAQ;QAC9B,MAAM,CAAC,CAAC,CAAC,IAAI;IACf,CAAC;IAED,gCAAe,GAAf;QACE,IAAM,UAAU,GAAG,EAAC,KAAK,EAAE,MAAM,EAAC;QAClC,IAAM,UAAU,GAAG,EAAC,KAAK,EAAE,MAAM,EAAE,SAAS,EAAE,EAAE,EAAE,YAAY,EAAE,EAAE,EAAC;QACnE,IAAM,GAAG,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,aAAa,GAAG,EAAE,CAAC,IAAI,EAAE;QAC1F,MAAM,CAAC,8BAAM,QAAQ,EAAE,IAAI,CAAC,mBAAmB;YACrC,IAAI,CAAC,KAAK,CAAC,cAAc,GAAG,6BAAK,KAAK,EAAE,UAAU,IAAG,IAAI,CAAC,KAAK,CAAC,cAAc,CAAO,GAAG,IAAI;YAC7F,+BAAO,OAAO,EAAC,eAAe,wCAA0C;YACxE,+BAAO,IAAI,EAAC,MAAM,EAAC,EAAE,EAAC,eAAe,EAAC,GAAG,EAAC,eAAe,EAAC,KAAK,EAAE,UAAU,EAAE,YAAY,EAAE,GAAG,GAAI;YAClG,+BAAO,IAAI,EAAC,QAAQ,EAAC,KAAK,EAAC,MAAM,GAAG,CAC/B;IAChB,CAAC;IAED,6BAAY,GAAZ;QACE,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;YACnB,MAAM,CAAC,6BAAK,EAAE,EAAC,QAAQ;gBACf,gCAAQ,GAAG,EAAC,QAAQ,EAAC,GAAG,EAAE,IAAI,CAAC,KAAK,CAAC,GAAG,GAAW;gBACnD,oBAAC,8BAAa,IAAC,mBAAmB,EAAE,IAAI,CAAC,KAAK,CAAC,mBAAmB,EAAE,OAAO,EAAE,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,aAAa,EAAE,IAAI,CAAC,KAAK,CAAC,aAAa,GAAI,CACxI;QACd,CAAC;QACD,MAAM,CAAC,IAAI;IACb,CAAC;IAED,uBAAM,GAAN;QACE,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC;YACzB,MAAM,CAAC,IAAI,CAAC,eAAe,EAAE;QAC/B,CAAC;QACD,MAAM,CAAC,IAAI,CAAC,YAAY,EAAE;IAC5B,CAAC;IACH,aAAC;AAAD,CAAC,CA9K2B,KAAK,CAAC,SAAS,GA8K1C;AA9KY,wBAAM","file":"iframe.js","sourcesContent":["import * as React from \"react\";\nimport * as ReactDOM from \"react-dom\";\nimport { IFrame } from \"./components/iframe\"\n\nReactDOM.render(\n    <IFrame />,\n    document.getElementById(\"app\")\n);\n\n\n// WEBPACK FOOTER //\n// ./src/iframe.tsx","import * as React from \"react\";\nimport { IFrameOverlay } from \"./iframe-overlay\"\n\nconst queryString = require(\"query-string\")\nconst superagent = require(\"superagent\")\n\ndeclare var firebase: any  // @types/firebase is not Firebase 3\ndeclare var iframePhone: any\n\nexport interface IFrameProps {\n}\n\nexport interface IFrameState {\n  src: string|null\n  irsUrl: string|null\n  copyUrl: string|null\n  authoring: boolean,\n  authoredState: AuthoredState|null,\n  authoringError: string|null\n  initInteractiveData: InitInteractiveData|null\n}\n\nexport interface AuthoredState {\n  laraSharedUrl: string\n  docStoreUrl: string\n  autoLaunchUrl: string\n  codapUrl: string\n}\n\nexport interface InteractiveRunStateData {\n  docStoreUrl: string\n  copyUrl: string\n}\n\nexport interface InitInteractiveData {\n  version: number\n  error: string|null\n  mode: \"authoring\"|\"runtime\"\n  authoredState: AuthoredState\n  interactiveState: any|null\n  globalInteractiveState: any|null\n  hasLinkedInteractive: boolean\n  linkedState: any|null\n  interactiveStateUrl: string\n  collaboratorUrls: string|null\n  publicClassHash: string|null\n  classInfoUrl: string|null\n  interactive: InitInteractiveInteractiveData\n  authInfo: InitInteractiveAuthInfoData\n}\n\nexport interface InitInteractiveInteractiveData {\n  id: number\n  name: string\n}\nexport interface InitInteractiveAuthInfoData {\n  provider: string\n  loggedIn: boolean\n  email: string\n}\n\nexport class IFrame extends React.Component<IFrameProps, IFrameState> {\n  private classroomRef:any\n  private clientPhone:any\n  private serverPhone:any\n\n  refs: {\n    [string: string]: any;\n    iframe: HTMLIFrameElement;\n    laraSharedUrl: HTMLInputElement;\n  }\n\n  constructor(props: IFrameProps) {\n    super(props)\n\n    this.submitAuthoringInfo = this.submitAuthoringInfo.bind(this)\n    this.getInteractiveState = this.getInteractiveState.bind(this)\n    this.delayedMount = this.delayedMount.bind(this)\n\n    this.state = {\n      irsUrl: null,\n      src: null,\n      authoring: false,\n      authoredState: null,\n      authoringError: null,\n      initInteractiveData: null,\n      copyUrl: null\n    }\n  }\n\n  componentDidMount() {\n    // TODO: figure out why iframe phone needs the delay\n    setTimeout(this.delayedMount, 1000)\n  }\n\n  delayedMount() {\n    this.clientPhone = iframePhone.getIFrameEndpoint()\n    this.clientPhone.addListener('initInteractive', (data:InitInteractiveData) => {\n      if (data.mode === \"authoring\") {\n        this.setState({\n          authoring: true,\n          authoredState: data.authoredState\n        })\n        return\n      }\n\n      const authoredState:AuthoredState = data.authoredState\n      const src = `${authoredState.autoLaunchUrl}?${queryString.stringify({server: authoredState.codapUrl})}`\n\n      this.setState({\n        src: src,\n        irsUrl: data.interactiveStateUrl,\n        initInteractiveData: data,\n        authoredState: data.authoredState\n      })\n\n      if (data.interactiveStateUrl)  {\n        setTimeout(this.getInteractiveState, 1000)\n      }\n    })\n    this.clientPhone.initialize();\n    this.clientPhone.post('supportedFeatures', {\n      apiVersion: 1,\n      features: {\n        authoredState: true\n      }\n    })\n  }\n\n  componentDidUpdate() {\n    if (this.state.authoring) {\n      this.refs.laraSharedUrl.focus()\n    }\n    else if (this.refs.iframe && !this.serverPhone) {\n      // proxy the result of the initInteractive message from LARA to the docstore\n      this.serverPhone = new iframePhone.ParentEndpoint(this.refs.iframe, () => {\n        this.serverPhone.post(\"initInteractive\", this.state.initInteractiveData)\n      })\n    }\n  }\n\n  getInteractiveState() {\n    const iframe = this\n    superagent\n      .get(this.state.irsUrl)\n      .withCredentials()\n      .set('Accept', 'application/json')\n      .end((err:any, res:any) => {\n        if (!err) {\n          try {\n            const json = JSON.parse(res.text)\n            if (json && json.raw_data) {\n              const rawData = JSON.parse(json.raw_data)\n              if (rawData && rawData.docStore && rawData.docStore.accessKeys && rawData.docStore.accessKeys.readOnly && this.state.authoredState) {\n                iframe.setState({\n                  copyUrl: `${this.state.authoredState.docStoreUrl}/v2/documents?source=${rawData.docStore.recordid}&accessKey=RO::${rawData.docStore.accessKeys.readOnly}`,\n                })\n              }\n              return\n            }\n          }\n          catch (e) {}\n          setTimeout(this.getInteractiveState, 1000)\n        }\n      });\n  }\n\n  submitAuthoringInfo(e:React.FormEvent<HTMLFormElement>) {\n    e.preventDefault()\n\n    const url = this.refs.laraSharedUrl.value\n    let [docStoreUrl, query, ...rest] = url.split(\"?\")\n    const urlMatches = docStoreUrl.match(/^((https?:\\/\\/[^/]+\\/)v2\\/documents\\/\\d+\\/(auto)?launch)/)\n    const launchParams = queryString.parse(query || \"\")\n\n    if (!urlMatches || !launchParams.server) {\n      this.setState({authoringError: \"This URL does not appear to be a shared URL from the LARA tab in CODAP\"})\n      return\n    }\n    this.setState({authoringError: null})\n\n    docStoreUrl = this.matchProtocol(urlMatches[2].replace(/\\/+$/, \"\")) // remove trailing slashes\n\n    let codapUrl\n    [codapUrl, query, ...rest] = launchParams.server.split(\"?\")\n    const codapParams = queryString.parse(query || \"\")\n    codapParams.componentMode = \"yes\"\n    codapParams.documentServer = docStoreUrl\n    codapUrl = this.matchProtocol(`${codapUrl}?${queryString.stringify(codapParams)}`)\n\n    const authoredState:AuthoredState = {\n      laraSharedUrl: url,\n      docStoreUrl: codapParams.documentServer,\n      autoLaunchUrl: this.matchProtocol(urlMatches[1].replace(\"/launch\", \"/autolaunch\")), // change to autolaunch\n      codapUrl: codapUrl\n    }\n\n    this.clientPhone.post('authoredState', authoredState)\n  }\n\n  matchProtocol(url:string):string {\n    const a = document.createElement(\"a\")\n    a.href = url\n    a.protocol = location.protocol\n    return a.href\n  }\n\n  renderAuthoring():JSX.Element {\n    const inputStyle = {width: \"100%\"}\n    const errorStyle = {color: \"#f00\", marginTop: 10, marginBottom: 10}\n    const url = (this.state.authoredState ? this.state.authoredState.laraSharedUrl : \"\") || \"\"\n    return <form onSubmit={this.submitAuthoringInfo}>\n             {this.state.authoringError ? <div style={errorStyle}>{this.state.authoringError}</div> : null}\n             <label htmlFor=\"laraSharedUrl\">Shared URL from LARA tab in CODAP</label>\n             <input type=\"text\" id=\"laraSharedUrl\" ref=\"laraSharedUrl\" style={inputStyle} defaultValue={url} />\n             <input type=\"submit\" value=\"Save\" />\n           </form>\n  }\n\n  renderIFrame():JSX.Element {\n    if (this.state.src) {\n      return <div id=\"iframe\">\n              <iframe ref=\"iframe\" src={this.state.src}></iframe>\n              <IFrameOverlay initInteractiveData={this.state.initInteractiveData} copyUrl={this.state.copyUrl} authoredState={this.state.authoredState} />\n            </div>\n    }\n    return null\n  }\n\n  render() {\n    if (this.state.authoring) {\n      return this.renderAuthoring()\n    }\n    return this.renderIFrame()\n  }\n}\n\n\n// WEBPACK FOOTER //\n// ./src/components/iframe.tsx"],"sourceRoot":""}